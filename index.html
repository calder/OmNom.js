<!DOCTYPE html>
<html lang="en">
<head>
<link rel="stylesheet" type="text/css" href="styles.css">
<script src="lib/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="lib/d3.js" type="text/javascript" charset="utf-8"></script>
<script src="lib/underscore.js" type="text/javascript" charset="utf-8"></script>
<script src="parse.js" type="text/javascript" charset="utf-8"></script>
<title>Om Nom</title>
</head>
<body>

<div id="grammar"></div><div id="input"></div>
<div id="tree">
  <ul>
    <li></li>
  </ul>
</div>
    
<script>
  var grammar = ace.edit("grammar");
  grammar.setTheme("ace/theme/solarized_dark");
  grammar.getSession().setMode("ace/mode/ebnf");

  var input = ace.edit("input");
  input.setTheme("ace/theme/solarized_light");
  input.getSession().setMode("ace/mode/ebnf");

  grammar.setValue('##################\n###   Tokens   ###\n##################\n\nsymbol  = "[[:alpha:]][\\w-]*\\??|=|\\+|-|\\*|/|<|>"\nstring  = "\\"([^\\\\\\"]*(\\\\.)?)*\\""\nint     = "\\d+"\nfloat   = "\\d*\\.\\d+|\\d+\\.\\d*"\nbool    = "#[tf]"\nquote   = "\\\'"\nop      = "\\("\ncp      = "\\)"\n        = "[ \\t\\n]+"\n\n\n###################\n###   Symbols   ###\n###################\n\nINPUT       = EXPRESSION *\nEXPRESSION  = ATOM | LIST | quote EXPRESSION\nATOM        = symbol | string | int | float | bool\nLIST        = op EXPRESSION * cp\n\n\n#################\n###   Names   ###\n#################\n\nsymbol      "symbol"\nstring      "string"\nint         "integer"\nfloat       "float"\nbool        "boolean"\nquote       "literal"\nop          "\'(\'"\ncp          "\')\'"\nnl          "end of line"\nINPUT       "input"\nEXPRESSION  "expression"\nATOM        "atom"\nLIST        "list"')
  grammar.clearSelection()
</script>

<script>
  var gparser = new BasicParser(
    {
      symbol:   "\\w+",
      string:   '"([^\\\\"]*(\\\\.)*)*"',
      eq:       "=",
      star:     "\\*",
      pipe:     "\\|",
      op:       "\\(",
      cp:       "\\)",
      nl:       "\n",
      $space:   "[ \t]+",
      $comment: "#[^\n]*"
    },
    {
      input:      "nl * tokens expansions names",
      tokens:     "token *",
      token:      "symbol eq string nl nl * | eq string nl nl *",
      expansions: "expansion *",
      expansion:  "symbol eq option option2 * nl nl *",
      option:     "option3 *",
      option2:    "pipe option",
      option3:    "symbol | symbol star",
      names:      "name *",
      name:       "symbol string nl nl *"
    },
    {
      symbol:   "symbol",
      string:   "string",
      eq:       "'='",
      star:     "'*'",
      pipe:     "'|'",
      op:       "'('",
      cp:       "')'",
      nl:       "\\n",
      $space:   "whitespace",
      $comment: "comment"
    },
    32
  )

  var parse = function () {
    var tree = gparser.parse(grammar.getValue()+"\n")
    var node = d3.select("#tree ul li")
    node.html("<a></a><ul></ul>")
    renderTree(tree, node)
  }

  var renderTree = function (tree, node) {
    node.select("a")
      .attr("class", tree.token ? "token" : "symbol")
      .html(tree.token ? nice(tree.token.token) : tree.symbol)

    var children = node.select("ul").selectAll("li")
      .data(tree.children||[])

    var newChildren = children.enter().append("li")
    newChildren.append("a")
    newChildren.append("ul")

    children
      .each(function (d) {
        renderTree(d, d3.select(this))
      })
    
    children.exit().remove()
  }

  var nice = function (s) {
    return s
      .replace("\n", "\\n")
      .replace("\t", "\\t")
  }

  grammar.getSession().on("change", parse);
  input.getSession().on("change", parse);
  parse()
</script>

</body>
</html>